<div id="camac-pulse-root">
    <style>
        #camac-pulse-root {
            --cp-primary: #0f172a; --cp-accent: #3b82f6; --cp-success: #10b981;
            --cp-text: #1e293b; --cp-bg: #ffffff; --cp-border: #e2e8f0;
            font-family: 'Inter', sans-serif;
            color: var(--cp-text);
            background: var(--cp-bg);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--cp-border);
            line-height: 1.5;
        }

        .cp-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        .cp-upload-zone { 
            border: 2px dashed var(--cp-border); 
            padding: 40px; text-align: center; border-radius: 12px; margin-bottom: 20px;
        }

        .cp-stats { 
            display: none; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
            gap: 15px; margin-bottom: 20px; 
        }

        .cp-card { 
            background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid var(--cp-border); 
        }

        .cp-card-label { font-size: 10px; text-transform: uppercase; font-weight: 700; color: #64748b; }
        .cp-card-val { font-size: 18px; font-weight: 800; }

        .cp-controls { 
            display: none; grid-template-columns: 1fr 1fr; gap: 10px; 
            background: #f1f5f9; padding: 15px; border-radius: 8px; margin-bottom: 10px;
        }

        #pulseCanvas { width: 100%; height: 400px; background: white; border-radius: 8px; cursor: crosshair; }

        .cp-btn {
            background: var(--cp-accent); color: white; border: none; 
            padding: 10px 18px; border-radius: 6px; cursor: pointer; font-weight: 600;
        }
        
        select, input { width: 100%; padding: 8px; border: 1px solid var(--cp-border); border-radius: 4px; }
    </style>

    <div class="cp-header">
        <strong>CamacPulse <span style="color:var(--cp-accent)">Intelligence</span></strong>
        <button class="cp-btn" style="font-size:11px" onclick="location.reload()">Reset</button>
    </div>

    <div id="cp-upload" class="cp-upload-zone">
        <h3>Analytical Engine</h3>
        <p>Upload a .csv or .xlsx file to start</p>
        <input type="file" id="cp-file" accept=".csv, .xlsx, .xls">
    </div>

    <div id="cp-dash" class="cp-stats">
        <div class="cp-card"><div class="cp-card-label">Avg Performance</div><div id="cp-vAvg" class="cp-card-val">0</div></div>
        <div class="cp-card"><div class="cp-card-label">Forecast</div><div id="cp-vFore" class="cp-card-val">0</div></div>
        <div class="cp-card"><div class="cp-card-label">Confidence</div><div id="cp-vConf" class="cp-card-val">0%</div></div>
    </div>

    <div id="cp-main" style="display:none;">
        <div class="cp-controls">
            <div><label style="font-size:10px">X Axis</label><select id="cp-pickX" onchange="cpDraw()"></select></div>
            <div><label style="font-size:10px">Y Axis</label><select id="cp-pickY" onchange="cpDraw()"></select></div>
            <div><label style="font-size:10px">Forecast Steps</label><input type="number" id="cp-steps" value="3" oninput="cpDraw()"></div>
        </div>
        <canvas id="pulseCanvas"></canvas>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        let cpData = [];
        let cpMouse = { x: -1, y: -1 };
        let cpPoints = [];

        document.getElementById('cp-file').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = (f) => {
                const workbook = XLSX.read(new Uint8Array(f.target.result), {type: 'array'});
                cpData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                cpInit();
            };
            reader.readAsArrayBuffer(e.target.files[0]);
        });

        function cpInit() {
            if(!cpData.length) return;
            const keys = Object.keys(cpData[0]);
            const sx = document.getElementById('cp-pickX'), sy = document.getElementById('cp-pickY');
            sx.innerHTML = ''; sy.innerHTML = '';
            keys.forEach(k => { sx.add(new Option(k,k)); sy.add(new Option(k,k)); });
            if(keys.length > 1) sy.selectedIndex = 1;
            
            document.getElementById('cp-upload').style.display = 'none';
            document.getElementById('cp-dash').style.display = 'grid';
            document.getElementById('cp-main').style.display = 'block';
            cpDraw();
        }

        const canvas = document.getElementById('pulseCanvas');
        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            cpMouse = { x: e.clientX - rect.left, y: e.clientY - rect.top };
            cpDraw();
        });

        function cpDraw() {
            const ctx = canvas.getContext('2d');
            const xK = document.getElementById('cp-pickX').value;
            const yK = document.getElementById('cp-pickY').value;
            const steps = parseInt(document.getElementById('cp-steps').value) || 0;

            const pts = cpData.map(d => ({
                x: String(d[xK]),
                y: parseFloat(String(d[yK]).replace(/[^0-9.-]/g, ''))
            })).filter(p => !isNaN(p.y));

            const n = pts.length;
            if(!n) return;

            // Stats Logic
            let sX=0, sY=0, sXY=0, sXX=0;
            pts.forEach((p, i) => { sX+=i; sY+=p.y; sXY+=i*p.y; sXX+=i*i; });
            const m = (n*sXY - sX*sY)/(n*sXX - sX*sX) || 0, b = (sY - m*sX)/n;

            document.getElementById('cp-vAvg').innerText = Math.round(sY/n).toLocaleString();
            document.getElementById('cp-vFore').innerText = Math.round(m*(n+steps-1)+b).toLocaleString();

            // Canvas Setup
            const dpr = window.devicePixelRatio || 1;
            canvas.width = canvas.offsetWidth * dpr; canvas.height = canvas.offsetHeight * dpr;
            ctx.scale(dpr, dpr);
            const w = canvas.offsetWidth, h = canvas.offsetHeight;
            const pL = 50, pR = 50, pT = 40, pB = 60;
            
            const maxVal = Math.max(...pts.map(p=>p.y), m*(n+steps)+b) * 1.2;
            const stepW = (w - pL - pR) / (n + steps - 1);
            
            ctx.clearRect(0,0,w,h);
            cpPoints = [];

            // Draw Y Axis Grid
            ctx.strokeStyle = "#e2e8f0"; ctx.lineWidth = 1;
            for(let i=0; i<=4; i++) {
                let y = (h-pB) - (i/4 * (h-pB-pT));
                ctx.beginPath(); ctx.moveTo(pL, y); ctx.lineTo(w-pR, y); ctx.stroke();
            }

            // Draw Lines
            ctx.beginPath();
            ctx.strokeStyle = "#3b82f6"; ctx.lineWidth = 3;
            pts.forEach((p, i) => {
                const vx = pL + (i * stepW);
                const vy = (h-pB) - (p.y/maxVal * (h-pB-pT));
                if(i === 0) ctx.moveTo(vx, vy); else ctx.lineTo(vx, vy);
                cpPoints.push({x: vx, y: vy, val: p.y, label: p.x});
            });
            ctx.stroke();

            // Forecast Extension
            ctx.beginPath(); ctx.setLineDash([5,5]);
            ctx.moveTo(cpPoints[n-1].x, cpPoints[n-1].y);
            for(let i=1; i<=steps; i++) {
                const curIdx = n-1+i;
                const fx = pL + (curIdx * stepW);
                const fv = m*curIdx + b;
                const fy = (h-pB) - (fv/maxVal * (h-pB-pT));
                ctx.lineTo(fx, fy);
                cpPoints.push({x: fx, y: fy, val: fv, label: 'Forecast'});
            }
            ctx.stroke(); ctx.setLineDash([]);

            // Hover Interaction
            cpPoints.forEach(pt => {
                const dist = Math.sqrt((cpMouse.x - pt.x)**2 + (cpMouse.y - pt.y)**2);
                if(dist < 15) {
                    ctx.fillStyle = "#3b82f6";
                    ctx.beginPath(); ctx.arc(pt.x, pt.y, 6, 0, Math.PI*2); ctx.fill();
                    ctx.strokeStyle = "white"; ctx.lineWidth = 2; ctx.stroke();
                    
                    ctx.fillStyle = "#0f172a"; ctx.font = "bold 12px sans-serif"; ctx.textAlign = "center";
                    ctx.fillText(Math.round(pt.val).toLocaleString(), pt.x, pt.y - 15);
                }
            });
        }
    </script>
</div>

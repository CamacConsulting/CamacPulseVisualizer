<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CamacPulseVisualizer | Fixed</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root { --teal: #41797e; --navy: #001935; }
        body { font-family: sans-serif; background: #f0f4f8; padding: 20px; color: var(--navy); }
        .box { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-top: 6px solid var(--teal); }
        .upload-area { border: 2px dashed #ccc; padding: 30px; text-align: center; margin-bottom: 20px; border-radius: 8px; }
        .dashboard { display: none; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .card { background: var(--navy); color: white; padding: 15px; border-radius: 6px; text-align: center; }
        .card span { display: block; font-size: 22px; font-weight: bold; color: #5aa4ab; }
        canvas { width: 100%; height: 500px; border: 1px solid #ddd; margin-top: 10px; }
        select, input { padding: 8px; margin: 5px 0; width: 100%; }
        .hidden-input { margin-bottom: 20px; padding: 10px; background: #eee; border-radius: 5px; }
    </style>
</head>
<body>

<div class="box">
    <h2>Pulse Visualizer</h2>
    
    <div id="setup">
        <p><strong>Step 1: Select your Excel/CSV file</strong></p>
        <div class="hidden-input">
            <input type="file" id="filePicker" accept=".xlsx, .xls, .csv">
        </div>
    </div>

    <div id="mainApp" style="display:none;">
        <div class="dashboard">
            <div class="card">AVERAGE <span id="vAvg">0</span></div>
            <div class="card">TREND <span id="vTrend">---</span></div>
            <div class="card">FORECAST <span id="vFore">0</span></div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; background: #f9f9f9; padding: 15px; border-radius: 8px;">
            <div><label>X-Axis</label><select id="pickX" onchange="render()"></select></div>
            <div><label>Y-Axis</label><select id="pickY" onchange="render()"></select></div>
            <div><label>Target</label><input type="number" id="pickGoal" oninput="render()" placeholder="Goal..."></div>
        </div>

        <canvas id="chartCanvas"></canvas>
    </div>
</div>

<script>
    const filePicker = document.getElementById('filePicker');
    let dataStore = [];

    filePicker.onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(evt) {
            try {
                const workbook = XLSX.read(new Uint8Array(evt.target.result), {type: 'array'});
                dataStore = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                if (dataStore.length > 0) start();
            } catch(err) { alert("Error reading file"); }
        };
        reader.readAsArrayBuffer(file);
    };

    function start() {
        const keys = Object.keys(dataStore[0]);
        const sx = document.getElementById('pickX'), sy = document.getElementById('pickY');
        keys.forEach(k => { sx.add(new Option(k,k)); sy.add(new Option(k,k)); });
        if(keys.length > 1) sy.selectedIndex = 1;

        document.getElementById('setup').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        document.querySelector('.dashboard').style.display = 'grid';
        render();
    }

    function render() {
        const canvas = document.getElementById('chartCanvas'), ctx = canvas.getContext('2d');
        const xK = document.getElementById('pickX').value, yK = document.getElementById('pickY').value;
        const goal = parseFloat(document.getElementById('pickGoal').value) || 0;

        const pts = dataStore.map(d => ({
            x: String(d[xK]),
            y: parseFloat(String(d[yK]).replace(/[^0-9.-]/g, ''))
        })).filter(p => !isNaN(p.y));

        const n = pts.length, ys = pts.map(p => p.y);
        let sX=0, sY=0, sXY=0, sXX=0;
        ys.forEach((y,x) => { sX+=x; sY+=y; sXY+=x*y; sXX+=x*x; });
        const m = (n*sXY - sX*sY)/(n*sXX - sX*sX) || 0, b = (sY - m*sX)/n;

        document.getElementById('vAvg').innerText = Math.round(ys.reduce((a,b)=>a+b,0)/n).toLocaleString();
        document.getElementById('vFore').innerText = Math.round(m*n+b).toLocaleString();
        document.getElementById('vTrend').innerText = m > 0 ? "Up" : "Down";

        // DRAWING
        const dpr = 2;
        canvas.width = canvas.offsetWidth * dpr; canvas.height = canvas.offsetHeight * dpr;
        ctx.scale(dpr, dpr);
        const w = canvas.offsetWidth, h = canvas.offsetHeight;
        const pL = 80, pR = 150, pT = 50, pB = 80;

        const max = Math.max(...ys, (m*n+b), goal) * 1.3;
        const step = (w - pL - pR) / (n - 1 || 1);

        ctx.fillStyle = "white"; ctx.fillRect(0,0,w,h);
        
        // Target
        if(goal > 0) {
            const gy = (h-pB) - (goal/max*(h-pB-pT));
            ctx.strokeStyle = "red"; ctx.setLineDash([2,2]);
            ctx.beginPath(); ctx.moveTo(pL, gy); ctx.lineTo(w-pR, gy); ctx.stroke();
            ctx.fillStyle = "red"; ctx.font = "10px sans-serif"; ctx.fillText("TARGET", w-pR+10, gy+3);
        }

        // Forecast
        ctx.setLineDash([4,4]); ctx.strokeStyle = "#ccc"; ctx.beginPath();
        for(let i=0; i<=n; i++) {
            const py = (h-pB) - ((m*i+b)/max*(h-pB-pT)), px = pL+(i*step);
            if(i===0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
            if(i===n) {
                ctx.stroke(); ctx.setLineDash([]); ctx.fillStyle = "teal";
                ctx.beginPath(); ctx.arc(px, py, 5, 0, 7); ctx.fill();
                ctx.fillText("FORECAST", px+10, py+3);
            }
        }

        // Line
        ctx.setLineDash([]); ctx.strokeStyle = "teal"; ctx.lineWidth = 3; ctx.beginPath();
        pts.forEach((p, i) => {
            const x = pL+(i*step), y = (h-pB) - (p.y/max*(h-pB-pT));
            if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
            ctx.fillStyle = "#666"; ctx.font = "10px sans-serif";
            ctx.fillText(p.x, x-10, h-pB+20);
        });
        ctx.stroke();
    }
</script>
</body>
</html>

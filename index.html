<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CamacPulseVisualizer | Fail-Safe</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --teal: #41797e; --navy: #001935; --bg: #f4f7f9; --text: #333; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .container { max-width: 900px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        .upload-area { border: 3px dashed var(--teal); padding: 40px; text-align: center; cursor: pointer; border-radius: 10px; margin-bottom: 20px; transition: 0.3s; }
        .upload-area:hover { background: rgba(65, 121, 126, 0.05); }
        
        #results { display: none; }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; background: #eee; padding: 15px; border-radius: 8px; }
        canvas { width: 100%; height: 400px; background: white; border: 1px solid #ddd; border-radius: 5px; }
        
        .status-badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; margin-bottom: 10px; }
        .status-ready { background: #d4edda; color: #155724; }
        .status-working { background: #fff3cd; color: #856404; }

        .fixed-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--navy); padding: 15px; text-align: center; }
        .fixed-footer a { color: white; text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div id="status" class="status-badge status-ready">SYSTEM: STANDBY</div>
    <h1>CamacPulseVisualizer</h1>
    
    <div class="upload-area" id="dropZone">
        <strong>STEP 1: Drop Excel or CSV here</strong>
        <p>Or click to browse files</p>
        <input type="file" id="filePicker" style="display:none" accept=".xlsx, .xls, .csv">
    </div>

    <div id="results">
        <div class="controls">
            <div>
                <label>Labels (X-Axis)</label>
                <select id="selX" style="width:100%"></select>
            </div>
            <div>
                <label>Values (Y-Axis)</label>
                <select id="selY" style="width:100%"></select>
            </div>
        </div>
        <div style="margin-bottom: 15px; text-align: center;">
            <button onclick="draw('line')" style="padding:10px 20px; cursor:pointer">ðŸ“ˆ LINE PULSE</button>
            <button onclick="draw('bar')" style="padding:10px 20px; cursor:pointer">ðŸ“Š BAR GROWTH</button>
            <button onclick="saveImage()" style="padding:10px 20px; cursor:pointer; background:var(--teal); color:white; border:none; border-radius:4px;">ðŸ’¾ SAVE IMAGE</button>
        </div>
        <canvas id="mainCanvas"></canvas>
    </div>
</div>

<div class="fixed-footer">
    <a href="https://camacconsulting.github.io/CamacPulseVisualizer/" target="_blank">VIEW FULL WINDOW â†—</a>
</div>

<script>
    const dropZone = document.getElementById('dropZone');
    const filePicker = document.getElementById('filePicker');
    const status = document.getElementById('status');
    let globalData = [];

    // Handle Click and Drag/Drop
    dropZone.onclick = () => filePicker.click();
    filePicker.onchange = (e) => handleFile(e.target.files[0]);
    
    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.style.background = "#eefaff"; };
    dropZone.ondragleave = () => { dropZone.style.background = "transparent"; };
    dropZone.ondrop = (e) => {
        e.preventDefault();
        handleFile(e.dataTransfer.files[0]);
    };

    function handleFile(file) {
        if (!file) return;
        status.className = "status-badge status-working";
        status.innerText = "READING: " + file.name;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                globalData = XLSX.utils.sheet_to_json(sheet);

                if (globalData.length > 0) {
                    initInterface(Object.keys(globalData[0]));
                } else {
                    alert("No data found in this file.");
                }
            } catch (err) {
                console.error(err);
                alert("Error: File could not be parsed.");
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function initInterface(headers) {
        const selX = document.getElementById('selX');
        const selY = document.getElementById('selY');
        selX.innerHTML = ""; selY.innerHTML = "";
        
        headers.forEach(h => {
            selX.add(new Option(h, h));
            selY.add(new Option(h, h));
        });
        
        if (headers.length > 1) selY.selectedIndex = 1;

        document.getElementById('results').style.display = 'block';
        status.className = "status-badge status-ready";
        status.innerText = "DATA MAPPED";
        
        selX.onchange = () => draw('line');
        selY.onchange = () => draw('line');
        
        draw('line');
    }

    function draw(type) {
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const xKey = document.getElementById('selX').value;
        const yKey = document.getElementById('selY').value;

        // Prep Data
        const points = globalData.map(d => ({
            label: String(d[xKey]),
            val: parseFloat(String(d[yKey]).replace(/[^0-9.-]/g, ''))
        })).filter(p => !isNaN(p.val));

        // Canvas Sizing
        canvas.width = canvas.offsetWidth * 2;
        canvas.height = canvas.offsetHeight * 2;
        ctx.scale(2, 2);
        const w = canvas.offsetWidth;
        const h = canvas.offsetHeight;
        const pad = 50;

        // Scaling
        const max = Math.max(...points.map(p => p.val)) * 1.1;
        const step = (w - (pad * 2)) / (points.length - 1 || 1);

        ctx.clearRect(0, 0, w, h);
        ctx.fillStyle = "#fff"; ctx.fillRect(0,0,w,h);

        // Draw Logic
        ctx.beginPath();
        ctx.strokeStyle = "#41797e";
        ctx.lineWidth = 3;

        points.forEach((p, i) => {
            const x = pad + (i * step);
            const y = (h - pad) - (p.val / max * (h - pad * 2));
            
            if (type === 'line') {
                if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            } else {
                ctx.fillStyle = "#001935";
                ctx.fillRect(x - 10, y, 20, (h-pad) - y);
            }
        });
        if (type === 'line') ctx.stroke();
    }

    function saveImage() {
        const link = document.createElement('a');
        link.download = 'CamacPulse_Chart.png';
        link.href = document.getElementById('mainCanvas').toDataURL();
        link.click();
    }
</script>
</body>
</html>

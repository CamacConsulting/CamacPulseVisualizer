<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CamacPulseVisualizer | Full Intelligence View</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --teal: #41797e; --navy: #001935; --bg: #f8fafc; --red: #e11d48; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--navy); margin: 0; padding: 0 0 100px 0; }
        
        header { background: var(--navy); color: white; padding: 20px; text-align: center; border-bottom: 4px solid var(--teal); }
        .wrapper { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        
        /* Stats Display */
        .dashboard { display: none; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--navy); color: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 10px 15px rgba(0,0,0,0.1); }
        .card small { text-transform: uppercase; font-size: 11px; opacity: 0.7; letter-spacing: 1px; }
        .card div { font-size: 28px; font-weight: bold; color: #5aa4ab; margin-top: 5px; }

        /* Interface */
        .panel { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .upload-zone { border: 3px dashed #cbd5e1; padding: 50px; text-align: center; cursor: pointer; border-radius: 12px; background: #fafafa; }
        
        .controls { display: none; margin-top: 20px; background: #f1f5f9; padding: 20px; border-radius: 12px; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        label { font-size: 11px; font-weight: bold; text-transform: uppercase; color: #64748b; }
        select, input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #cbd5e1; margin-top: 5px; font-weight: 600; }

        canvas { width: 100%; height: 600px; margin-top: 20px; }

        .footer { position: fixed; bottom: 0; width: 100%; background: var(--navy); padding: 20px; text-align: center; border-top: 4px solid var(--teal); }
        .footer a { color: white; text-decoration: none; font-weight: bold; letter-spacing: 1px; }
    </style>
</head>
<body>

<header><strong>CAMACPULSE VISUALIZER</strong></header>

<div class="wrapper">
    <div class="dashboard" id="dash">
        <div class="card"><small>Average</small><div id="vAvg">0</div></div>
        <div class="card"><small>Trend</small><div id="vTrend">---</div></div>
        <div class="card"><small>Forecast</small><div id="vFore">0</div></div>
    </div>

    <div class="panel">
        <div class="upload-zone" id="dropZone">
            <h2>UPLOAD DATA</h2>
            <p>Click to select the file for full window analysis</p>
            <input type="file" id="fileIn" style="display:none" accept=".xlsx, .xls, .csv">
        </div>

        <div class="controls" id="ctrls">
            <div class="grid">
                <div><label>Labels (X)</label><select id="selX" onchange="render()"></select></div>
                <div><label>Data (Y)</label><select id="selY" onchange="render()"></select></div>
                <div><label>Target Goal</label><input type="number" id="goal" oninput="render()" placeholder="0"></div>
            </div>
        </div>

        <canvas id="pulseCanvas"></canvas>
    </div>
</div>

<div class="footer">
    <a href="javascript:void(0)" onclick="fullWindow()">VIEW IN FULL WINDOW / REFRESH â†—</a>
</div>

<script>
    const fileIn = document.getElementById('fileIn');
    let raw = [];

    document.getElementById('dropZone').onclick = () => fileIn.click();

    fileIn.onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (f) => {
            const wb = XLSX.read(new Uint8Array(f.target.result), {type: 'array'});
            raw = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            if(raw.length > 0) activate();
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    };

    function activate() {
        const keys = Object.keys(raw[0]);
        const sx = document.getElementById('selX'), sy = document.getElementById('selY');
        sx.innerHTML = ''; sy.innerHTML = '';
        keys.forEach(k => { sx.add(new Option(k,k)); sy.add(new Option(k,k)); });
        if(keys.length > 1) sy.selectedIndex = 1;

        document.getElementById('dropZone').style.display = 'none';
        document.getElementById('dash').style.display = 'grid';
        document.getElementById('ctrls').style.display = 'block';
        render();
    }

    function render() {
        const canvas = document.getElementById('pulseCanvas'), ctx = canvas.getContext('2d');
        const xK = document.getElementById('selX').value, yK = document.getElementById('selY').value;
        const goal = parseFloat(document.getElementById('goal').value) || 0;

        const data = raw.map(d => ({
            x: String(d[xK]),
            y: parseFloat(String(d[yK]).replace(/[^0-9.-]/g, ''))
        })).filter(p => !isNaN(p.y));

        const n = data.length, ys = data.map(p => p.y);
        let sX=0, sY=0, sXY=0, sXX=0;
        ys.forEach((y,x) => { sX+=x; sY+=y; sXY+=x*y; sXX+=x*x; });
        const m = (n*sXY - sX*sY)/(n*sXX - sX*sX) || 0, b = (sY - m*sX)/n;

        document.getElementById('vAvg').innerText = Math.round(ys.reduce((a,b)=>a+b,0)/n).toLocaleString();
        document.getElementById('vFore').innerText = Math.round(m*n+b).toLocaleString();
        document.getElementById('vTrend').innerText = m > 0 ? "Upward" : "Downward";

        const dpr = 2;
        canvas.width = canvas.offsetWidth * dpr; canvas.height = canvas.offsetHeight * dpr;
        ctx.scale(dpr, dpr);
